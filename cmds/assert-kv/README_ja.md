# assert-kv

Key-Value形式のデータが与えられたアサーションを満たすかどうかを検証するコマンド

todo: Key-Value形式の説明ページへのリンクを追加する

## インストール

assert-kvはawkで実装されているため特別なインストールは不要です。適当なディレクトリに`validate-kv`ファイルを配置し、実行権限を付与してください。

# Requirement

- awk(gawk/nawk)
- POSIX Compatible Shell

# Usage

```sh
assert-kv - Key-Value形式のデータが与えられたアサーションを満たすかどうかを検証するコマンド

Usage:
    assert-kv <rule file> <data file>

Options:
    rule file: ルールファイル
    data file: データファイル

Description:
    assert-kvは<rule file>に記載されたルールに従って
    <data file>のデータをバリデーションします。
    <data file>はKey-Value形式を前提としています。
```

# ルールファイルの書き方

## 基本事項

- 1行1ルール
- 評価結果が真であれば成功、偽であれば失敗

## 構文

```
<論理式> ::=
           | <not式>
           | <列挙値型前置単行演算式>
           | <項目値型後置単行演算式>
           | <論理式型中置二項演算式>
           | <is式>
           | '(' <論理式> ')'

<not式>                  ::= not <論理式>
<列挙値型前置単行演算式> ::= <列挙値型前置単項演算子> <列挙値>
<項目値型後置単行演算式> ::= <項目名> <項目値型後置単項演算子>
<論理式型中置二項演算式> ::= <論理式> <論理式型中置二項演算子> <論理式>
<is式>                   ::= <項目名> is <値>`

<列挙値型前置単項演算子> ::= exist_one_of | exist_two_of
<項目値型後置単項演算子> ::= is_exist | is_not_exist
<論理式型中置二項演算子> ::= or | and | == | implies | xor

<列挙値> ::= '[' <項目名> ( <項目名> )* ']'
<項目名> ::= 任意の文字列
<値>     ::= 任意の文字列
```

## 論理式の優先順位

1. 括弧内の式を最優先で評価。
2. not は最も強い優先順位を持つ。
3. 次に二項演算子の優先順位： and > or > implies > == > xor

## not式

BNF: `not <論理式>`

`not` は後続する論理式の否定を表します。

| 論理式 | not 論理式 |
|--------|------------|
| True   | False      |
| False  | True       |

## is式

BNF: `<項目名> is <値>`

データファイルの項目名の値が指定された値と等しい場合にTrueを返します。

## 列挙値型前置単項演算式

BNF: `<列挙値型前置単項演算子> <列挙値>`

| 列挙値型前置単項演算子 | 説明                                                                 |
|------------------------|--------------------------------------------------------------------|
| `exist_one_of`         | 列挙値のいずれかが存在する場合にTrueを返します。                        |
|  exist_two_of          | 列挙値の2つ以上が存在する場合にTrueを返します。                          |

## 項目値型後置単項演算式

BNF: `<項目名> <項目値型後置単項演算子>`


| 項目値型後置単項演算子 | 説明                                                                 |
|----------------|--------------------------------------------------------------------|
| `is_exist`     | 項目が存在する場合にTrueを返します。                                   |
| `is_not_exist` | 項目が存在しない場合にTrueを返します。                                  |

## 論理式型中置二項演算式

BNF: `<論理式> <論理式型中置二項演算子> <論理式>`


| 論理式型中置二項演算子 | 説明                                                                 |
|----------------|--------------------------------------------------------------------|
| `or`           | 論理和（例: `A or B` はAまたはBが真の場合に成立）。                  |
| `and`          | 論理積（例: `A and B` はAかつBが真の場合に成立）。                   |
| `==`           | 論理的同値（例: `A == B` はAとBが等しい場合に成立）。                |
| `implies`      | 論理的包含（例: `A implies B` はAが偽またはBが真の場合に成立）。       |
| `not`          | 否定（例: `not A` はAが偽の場合に成立）。                             |
| `xor`          | 排他的論理和（例: `A xor B` はAまたはBのどちらか一方が真の場合に成立）。 |

## コメントとフォーマット

- `#` で始まる行はコメントとして扱われ、バリデーション処理時に無視されます。
- 空行は無視されます。
- トークンは1つ以上の連続したスペースで区切りられます。
- 人間の読みやすさのために適宜スペースを追加してください。

## 例

```
# メールアドレスまたは電話番号のいずれかが必須
email is_exist  or  phone_number is_exist

# 郵便番号と住所は両方存在するか、どちらも存在しない
zipcode is_exist  ==  address is_exist

# primary_contact が email の場合、email が存在する必要がある
primary_contact == email    implies     email is_exist
```
